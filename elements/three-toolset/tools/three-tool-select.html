<!-- <link rel="import" href="../../three.html"> -->
<link rel="import" href="three-tool.html">

<!--
@element three-tool-select
-->

<polymer-element name="three-tool-select" extends="three-tool">
  <script>
  (function(){

    // TODO: move
    var selectrect = document.createElement('div');
    selectrect.style.position = 'absolute';
    selectrect.style.width = '100px';
    selectrect.style.height = '100px';
    selectrect.style.border = '1px dashed white';
    selectrect.style['pointer-events'] = 'none';

    var viewportRect;
    var x0, y0, x1, y1, w, h
    var viewport, vw, vh, renderData, projectedObjectIds = []; projectedObjects = [];

    var updateSelectrect = function() {
      w = Math.abs(x0 - x1);
      h = Math.abs(y0 - y1);
      selectrect.style.left = Math.min(x0, x1) + 'px';
      selectrect.style.top = Math.min(y0, y1) + 'px';
      selectrect.style.height = h + 'px';
      selectrect.style.width = w + 'px';
    };

    var projector = new THREE.Projector();

    Polymer({

      onDown: function(event) {
        viewportRect = event.path[0].getBoundingClientRect();
        x0 = x1 = event.clientX - viewportRect.left;
        y0 = y1 = event.clientY - viewportRect.top;
        updateSelectrect();
        // Add select rect to viewport
        event.path[0].shadowRoot.appendChild(selectrect);
      },

      onTrack: function(event) {
        viewportRect = event.path[0].getBoundingClientRect();
        x1 = event.clientX - viewportRect.left;
        y1 = event.clientY - viewportRect.top;
        updateSelectrect();
      },

      onUp: function(event) {
        if (w > 3 || h > 3) {
          viewport = event.path[0];
          vw = viewport.width;
          vh = viewport.height;
          renderData = null;
          projectedObjectIds = [];
          projectedObjects = [];
          if (viewport.camera instanceof THREE.PerspectiveCamera) {
            viewport.camera.setViewOffset(vw, vh, Math.min(x0, x1), Math.min(y0, y1), w, h);
            renderData = projector.projectScene( viewport.scene, viewport.camera, true, true );
            viewport.camera.setViewOffset(vw, vh, 0, 0, vw, vh);
          } else if (viewport.camera instanceof THREE.OrthographicCamera) {
            // TODO: move to camera
            var r = viewport.camera.right;
            var l = viewport.camera.left;
            var t = viewport.camera.top;
            var b = viewport.camera.bottom;
            var cw = r - l;
            var ch = b - t;
            // apply offset
            viewport.camera.top += (Math.min(y0, y1) / vh) * ch;
            viewport.camera.bottom -= (1-Math.max(y0, y1) / vh) * ch;
            viewport.camera.left += (Math.min(x0, x1) / vw) * cw;
            viewport.camera.right -= (1-Math.max(x0, x1) / vw) * cw;
            viewport.camera.updateProjectionMatrix();
            renderData = projector.projectScene( viewport.scene, viewport.camera, true, true );
            // restore offset
            viewport.camera.right = r;
            viewport.camera.left = l;
            viewport.camera.top = t;
            viewport.camera.bottom = b;
          }
          if (!renderData || !renderData.elements) return;
          //
          projectedObjectIds = [];
          projectedObjects = [];
          renderData.elements.forEach(function(element) {
            if (projectedObjectIds.indexOf(element.id) == -1) {
              projectedObjectIds.push(element.id);
            }
          });
          renderData.objects.forEach(function(object) {
            if (projectedObjectIds.indexOf(object.id) != -1) {
              if (projectedObjects.indexOf(object.object) == -1) {
                projectedObjects.push(object.object);
              }
            }
          });
          this.fire('io-help-message', 'Slect Tool: Selected ' + projectedObjects.length + ' objects.');
          this.selection.length = 0;
          this.selection.push(projectedObjects[0]);
          alert('Selected objects[' + projectedObjects.length + '].');
        } else {
          alert('Selected objects[1].');
          this.fire('io-help-message', 'Slect Tool: Selected 1 object.');
        }
        this.cancel(); // TODO: debug
        // Remove select rect from viewport
        if (selectrect.parentNode) selectrect.parentNode.removeChild(selectrect);
      },

      onMouseMove: function() {
        this.fire('io-help-message', 'Slect Tool: <b>Click</b> to select. Hold <b>Shift</b> to select multiple objects.');
      }
    });
  }());   
  </script>
</polymer-element>
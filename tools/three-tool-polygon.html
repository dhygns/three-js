<!--
Copyright 2012 Flux Factory, Inc.
-->

<!-- TODO(aki): documentation -->

<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="three-tool.html">

<polymer-element name="three-tool-polygon" attributes="scene" extends="three-tool">
  <script type="text/javascript">
    Polymer({

      scene: null,
      lineArray: null,
      vtxBuffer: null,
      indexBuffer: null,
      lineMesh: null,

      // 3D object used to visualize pointer position in 3D.
      pointer: new THREE.AxisHelper(2.5),

      begin: function() {
        this.super();

        this.lineArray = [];
        this.lineMesh = new THREE.Line(
          new THREE.BufferGeometry(),
          new THREE.LineBasicMaterial({
            linewidth: 3
          })
        );

        // Add pointer to the helper scene
        this.scene.helpers.add(this.pointer);
        this.fire('core-signal', {name: 'three-viewport', data: {action: 'renderLater'}});
      },

      end: function() {
        this.lineArray.length = 0;
        if (this.pointer.parent) {
          // Remove pointer from the helper scene
          this.pointer.parent.remove(this.pointer);
        }
        this.fire('core-signal', {name: 'three-viewport', data: {action: 'renderLater'}});
      },

      updateLine: function() {
        if (this.lineArray.length > 3) {
          if (this.lineMesh.parent != this.scene) {
            this.scene.add(this.lineMesh);
          }

          // TODO(aki): profile GC
          this.lineMesh.geometry.dispose();
          delete this.lineMesh.geometry.attributes.index;
          delete this.lineMesh.geometry.attributes.position;

          this.indexBuffer = new Uint32Array(this.lineArray.length / 3);
          this.lineMesh.geometry.addAttribute('index',
            new THREE.BufferAttribute(this.indexBuffer, 1));

          this.vtxBuffer = new Float32Array(this.lineArray.length);
          this.lineMesh.geometry.addAttribute('position',
            new THREE.BufferAttribute(this.vtxBuffer, 3));

          for (var i = 0; i < this.lineArray.length / 3; i++) {
            this.vtxBuffer[i * 3 + 0] = this.lineArray[i * 3 + 0];
            this.vtxBuffer[i * 3 + 1] = this.lineArray[i * 3 + 1];
            this.vtxBuffer[i * 3 + 2] = this.lineArray[i * 3 + 2];
            this.indexBuffer[i] = i;
          }

          this.lineMesh.geometry.computeBoundingSphere();
          this.lineMesh.geometry.attributes.index.needsUpdate = true;
          this.lineMesh.geometry.attributes.position.needsUpdate = true;
          this.lineMesh.geometry.__webglInit = undefined;
        }
      },

      addPoint: function(position) {
        this.lineArray.push(position.x);
        this.lineArray.push(position.y);
        this.lineArray.push(position.z);
        this.updateLine();
      },
      moveLastPoint: function(position) {
        this.lineArray[this.lineArray.length - 3] = position.x;
        this.lineArray[this.lineArray.length - 2] = position.y;
        this.lineArray[this.lineArray.length - 1] = position.z;
        this.updateLine();
      },

      // pointer events
      onMouseMove: function(event) {
        if (!event.pointOnPlane) return;
        this.pointer.position.copy(event.pointOnPlane);
      },
      onDown: function(event) {
        if (!event.pointOnPlane) return;
        this.addPoint(event.pointOnPlane);
        this.fire('core-signal', {name: 'three-viewport', data: {action: 'renderLater'}});
      },
      onTrack: function(event) {
       if (!event.pointOnPlane) return;
        this.pointer.position.copy(event.pointOnPlane);
        this.moveLastPoint(event.pointOnPlane);
      },
      onUp: function(event) {
        this.fire('core-signal', {name: 'three-viewport', data: {action: 'renderLater'}});
      },

      onKeyDown: function(event) {
        switch (event.which) {
          case 27: // esc
            this.end();
            // TODO: communicate end to app
            break;
          case 13: // enter
            this.end();
            this.begin();
            break;
        }
      }

    });

  </script>
</polymer-element>